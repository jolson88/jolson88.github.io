---
layout: post
title: Listing Running Transactions In A Resource Manager
---

<P mce_keep="true">&nbsp;</P>
<P>The more I work with TxF, the more I realize that our (Microsoft's) coverage of certain KTM topics is sorely lacking. One of those areas is around documentation and samples of managing resource managers (important if you are wanting to investigate programatically the running status of a resource manager). 
<P>Sometimes, being an evangelist can be quite fun (or frustrating) because the documentation leaves something to be desired and you can't run to the internet because the only results you get back or to the documentation on MSDN. And of course, since you're on the cutting searching for the control codes online provides you with two results, both pointing back to MSDN. It becomes doubly "interesting" if you are a managed developer because a large number of management-oriented information for KTM is all done through DeviceIoControl (an API that is NOT fun to try to P/Invoke into, especially using certain control codes). 
<P>Anyways, that's all beside the point... moving right along. 
<P>If you are writing an application to monitor TxF (or even building it into your own application), there are some core "things" that you need to do. One of the first ones (and the one I will cover in this post) is to get a list of transactions in a given resource manager. This is done using the <A href="http://msdn2.microsoft.com/en-us/library/aa364603.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/aa364603.aspx">FSCTL_TXFS_LIST_TRANSACTIONS</A> control code. 
<P>What structure is DeviceIoControl passing back to us in this instance? A <A href="http://msdn2.microsoft.com/en-us/library/aa365702.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/aa365702.aspx">TXFS_LIST_TRANSACTIONS</A> structure. Looking at this structure, we see two fields: NumberOfTransactions and BufferSizeRequired. <BR>That's nice and all, but where is the information about those transactions? The information is stored in a TXFS_LIST_TRANSACTIONS_ENTRY structure. 
<P>The trick is that the TXFS_LIST_TRANSACTIONS_ENTRY structure is mentioned nowhere in the documentation for FSCTL_TXFS_LIST_TRANSACTIONS. So how do you get to it? An array of TXFS_LIST_TRANSACTIONS_ENTRY structures are stored in memory after your TXFS_LIST_TRANSACTIONS structure. So assuming you have two running transactions in the given resource manager, you would pass in a pointer to the TXFS_LIST_TRANSACTIONS structure, and here is what the memory would actually look like coming back from DeviceIoControl: 
<P><A href="http://www.managed-world.com/images/Listingrunningtransactionsinaresourceman_BD53/MemoryLayout3.png" mce_href="http://www.managed-world.com/images/Listingrunningtransactionsinaresourceman_BD53/MemoryLayout3.png"><IMG style="BORDER-TOP-WIDTH: 0px; BORDER-LEFT-WIDTH: 0px; BORDER-BOTTOM-WIDTH: 0px; BORDER-RIGHT-WIDTH: 0px" height=189 src="http://www.managed-world.com/images/Listingrunningtransactionsinaresourceman_BD53/MemoryLayout_thumb3.png" width=710 border=0 mce_src="http://www.managed-world.com/images/Listingrunningtransactionsinaresourceman_BD53/MemoryLayout_thumb3.png"></A> 
<P>The impact of this is that you need to allocate enough memory for not only your TXFS_LIST_TRANSACTIONS structure, but the array of TXFS_LIST_TRANSACTIONS_ENTRY structures as well. You might notice a little bit of a "chicken and egg" problem here. If I'm using FSCTL_TXFS_LIST_TRANSACTIONS to retrieve the transactions, how could I know how many entry structures to allocate when I don't know how many transactions there are yet? 
<P>Well, assuming there are one or more running transactions in the resource manager, you have to call DeviceIoControl with FSCTL_TXFS_LIST_TRANSACTIONS at least twice: once to find out how big of a buffer you need to allocate (read: to calculate how many ENTRY structures to accomodate for), and then another time after allocating the extra memory to have it fill the actual ENTRY structures. 
<P>Why do I say "at least" twice? Because, between the time we make our first call and the time we make our second call, more transactions could have appeared and we will have to allocate even more memory. A little bit of a "cat and mouse game," I must say. 
<P>If you are a managed developer, this may sound a bit scary. Don't be scared though, it's not too bad (and I know I at least have fun writing this kind of lower-level code :P). 
<P>So let's dive right in and look at the code to make this work! 
<P>In pseudo-code, this is what we have to do: 
<P>------------------------<BR>while (true)<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;// Deallocate memory from last loop through this 
<P>&nbsp;&nbsp;&nbsp;&nbsp;// Allocate memory for transaction list buffer 
<P>&nbsp;&nbsp;&nbsp;&nbsp;// Call DeviceIoControl with FSCTL_TXFS_LIST_TRANSACTIONS 
<P>&nbsp;&nbsp;&nbsp;&nbsp;// If DeviceIoControl Succeeded 
<P>&nbsp;&nbsp;&nbsp;&nbsp;// Get list of transaction entries after TXFS_LIST_TRANSACTIONS structure<BR>} 
<P>// Deallocate any remaining memory<BR>------------------------ 
<P>Not that bad really. So here it is implemented in native code: 
<DIV style="FONT-SIZE: 10pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: consolas">
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">1</SPAN> <SPAN style="COLOR: blue">#include</SPAN> <SPAN style="COLOR: #a31515"><WINDOWS.H></SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">2</SPAN> <SPAN style="COLOR: blue">#include</SPAN> <SPAN style="COLOR: #a31515"><TCHAR.H></SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">3</SPAN> <SPAN style="COLOR: blue">#include</SPAN> <SPAN style="COLOR: #a31515"><STDIO.H></SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">4</SPAN> <SPAN style="COLOR: blue">#include</SPAN> <SPAN style="COLOR: #a31515">"Winioctl.h"</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">5</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">6</SPAN> <SPAN style="COLOR: blue">int</SPAN> _tmain(<SPAN style="COLOR: blue">int</SPAN> argc, LPTSTR argv)</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">7</SPAN> {</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">8</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;DWORD lastError, bytesReturned;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">9</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;HANDLE rmDirectory;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">10</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;TXFS_LIST_TRANSACTIONS *txList = NULL;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">11</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">12</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// Get handle to directory where resource manager resides</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">13</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;rmDirectory = CreateFile(TEXT(<SPAN style="COLOR: #a31515">"C:\\"</SPAN>), </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">14</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERIC_READ,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">15</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">16</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">17</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OPEN_EXISTING,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">18</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_FLAG_BACKUP_SEMANTICS,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">19</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL);</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">20</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">21</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">if</SPAN> (rmDirectory != INVALID_HANDLE_VALUE)</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">22</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">23</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// Get a list of transactions within the given</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">24</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// resource manager</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">25</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD neededBufferSize = <SPAN style="COLOR: blue">sizeof</SPAN>(TXFS_LIST_TRANSACTIONS);</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">26</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">while</SPAN> (<SPAN style="COLOR: blue">true</SPAN>)</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">27</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">28</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// Deallocate previously allocated memory if we are back</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">29</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// here after getting back ERROR_MORE_DATA</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">30</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">if</SPAN> (NULL != txList)</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">31</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">32</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">delete</SPAN>[] (<SPAN style="COLOR: blue">char</SPAN>*)txList;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">33</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txList = NULL;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">34</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">35</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">36</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// Get the list of running transactions in the RM</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">37</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txList = (TXFS_LIST_TRANSACTIONS*)<SPAN style="COLOR: blue">new</SPAN> <SPAN style="COLOR: blue">char</SPAN>[neededBufferSize];</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">38</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">if</SPAN> (!DeviceIoControl(rmDirectory,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">39</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FSCTL_TXFS_LIST_TRANSACTIONS,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">40</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">41</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">42</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txList,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">43</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neededBufferSize,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">44</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;bytesReturned,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">45</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL))</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">46</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">47</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// How did we fail?</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">48</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastError = GetLastError();</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">49</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">if</SPAN> (lastError == ERROR_MORE_DATA)</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">50</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">51</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// We need to enlarge the buffer and try again</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">52</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;neededBufferSize = txList-&gt;BufferSizeRequired;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">53</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">continue</SPAN>;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">54</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">55</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">else</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">56</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">57</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_tprintf(TEXT(<SPAN style="COLOR: #a31515">"Unhandled exception: %u\n"</SPAN>), lastError);</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">58</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">break</SPAN>;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">59</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">60</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">61</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">else</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">62</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">63</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_tprintf(TEXT(<SPAN style="COLOR: #a31515">"Transaction Count: %u\n\n"</SPAN>), txList-&gt;NumberOfTransactions);</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">64</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">65</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// List Tx details</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">66</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TXFS_LIST_TRANSACTIONS_ENTRY *txEntry;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">67</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txEntry = (TXFS_LIST_TRANSACTIONS_ENTRY *)((<SPAN style="COLOR: blue">char</SPAN> *)txList </P>
<P style="MARGIN: 0px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <SPAN style="COLOR: blue">sizeof</SPAN>(TXFS_LIST_TRANSACTIONS));</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">68</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">for</SPAN> (DWORD i = 0; i &lt; txList-&gt;NumberOfTransactions; i++)</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">69</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">70</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txEntry++;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">71</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">72</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// Get GUID string</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">73</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WCHAR szGuid[40];</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">74</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringFromGUID2(txEntry-&gt;TransactionId, (WCHAR *)&amp;szGuid, 40);</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">75</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">76</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// Print Tx info</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">77</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_tprintf(TEXT(<SPAN style="COLOR: #a31515">"TX %s: %u\n"</SPAN>), </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">78 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</SPAN>szGuid,</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">79</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txEntry-&gt;TransactionState);</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">80</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">81</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">82</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">break</SPAN>;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">83</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">84</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">85</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">86</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: green">// Any memory left to deallocate?</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">87</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">if</SPAN> (NULL != txList)</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">88</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">89</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">delete</SPAN>[] (<SPAN style="COLOR: blue">char</SPAN>*)txList;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">90</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txList = NULL;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">91</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">92</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">93</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">else</SPAN></P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">94</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;{</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">95</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_tprintf(TEXT(<SPAN style="COLOR: #a31515">"Unable to get valid handle to Resource Manager\n"</SPAN>));</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">96</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">return</SPAN> 1;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">97</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;}</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">98</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">99</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;_tprintf(TEXT(<SPAN style="COLOR: #a31515">"\nPress any key to exit...\n"</SPAN>));</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">100</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;getchar();</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">101</SPAN> </P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">102</SPAN> &nbsp;&nbsp;&nbsp;&nbsp;<SPAN style="COLOR: blue">return</SPAN> 0;</P>
<P style="MARGIN: 0px"><SPAN style="COLOR: #2b91af">103</SPAN> }</P></DIV>
<P>And that's how you do it. It's not the most fun getting in to DeviceIoControl (unless you're a geek like me and enjoying this kind of stuff), but hopefully with this post out there to help it will be easier to find out how to do this since there is a lack of documentation around this area. 
<P>In closing, there is some work that needs to be done around making management of kernel-level transactions a lot easier than it is now. In some ways, it is pretty clear that this is still a "1.0" technology. So while you could use the KTM directly for your transaction coordination, I would highly recommend sticking with using DTC for your transaction coordination as it is much more mature from a management perspective (and there are quite a few enhancements with DTC in Vista and Windows Server 2008). </P><img src="http://blogs.msdn.com/aggbug.aspx?PostID=3962895" width="1" height="1">
