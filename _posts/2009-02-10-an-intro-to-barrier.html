---
title: An Intro to Barrier
---

<p>Originally posted on: <a href='http://geekswithblogs.net/jolson/archive/2009/02/09/an-intro-to-barrier.aspx'>http://geekswithblogs.net/jolson/archive/2009/02/09/an-intro-to-barrier.aspx</a></p><p>In this first stage of our Tour de BCL, we will be passing through the new Barrier class. </p>  <p>So what is a Barrier? Let’s take a look at the <strike>boring</strike> technical description for a Barrier:</p>  <blockquote>   <p>A <strong>Barrier</strong> is a synchronization primitive that enforces the stopping of execution between a number of threads or processes at a given point and prevents further execution until all threads or processors have reached the given point.</p> </blockquote>  <p>I don’t know about you, but sometimes technical descriptions like the above just sound like “blah, blah, blah” to me. What does a Barrier really mean to me, as a developer. Let’s break it down a different way by looking at a specific real-life scenario.</p>  <h3>Think of a Road Trip</h3>  <p>Instead of looking at the technical description above, think of the concept of a road trip.</p>  <p>There are three friends, Mac, Charlie, and Dennis. They live in a small town south of Seattle but want to take a road trip up to Seattle. So Mac calls up Charlie and Dennis and says “Hey guys, let’s take a road trip to Seattle. Meet up at the local gas station and then we’ll all leave from there.” So now they all now they need to go to the local gas station, wait for all of them to show up, and then they’ll leave for Seattle together and follow each other there. </p>  <p><a href="http://gwb.blob.core.windows.net/jolson/WindowsLiveWriter/AnIntroductiontoBarrier_D0FA/Barrier_4.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Barrier" border="0" alt="Barrier" src="http://gwb.blob.core.windows.net/jolson/WindowsLiveWriter/AnIntroductiontoBarrier_D0FA/Barrier_thumb_1.png" width="441" height="256" /></a> </p>  <p>Relating this scenario to some code, let’s say that Charlie, Mac, and Dennis are all individual threads that have one method of execution, the DriveToSeattle() method. Within that method, they are all going “to drive” to the same gas station and then continue to drive to Seattle.</p>  <p>If we don’t use the Barrier to synchronize the work (aka wait for each other to arrive at the gas station), each one of them will leave for Seattle the second they arrive at the gas station: </p>  <pre class="csharpcode"><span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
{
    var charlie = <span class="kwrd">new</span> Thread(() =&gt; {
        DriveToSeattle(<span class="str">"Charlie"</span>, TimeSpan.FromSeconds(1))
    }); 
    charlie.Start();

    var mac = <span class="kwrd">new</span> Thread(() =&gt; {
        DriveToSeattle(<span class="str">"Mac"</span>, TimeSpan.FromSeconds(2))
    }); 
    mac.Start();

    var dennis = <span class="kwrd">new</span> Thread(() =&gt; {
        DriveToSeattle(<span class="str">"Dennis"</span>, TimeSpan.FromSeconds(3))
    }); 
    dennis.Start();

    charlie.Join();
    mac.Join();
    dennis.Join();

    Console.ReadKey();
}

<span class="kwrd">static</span> <span class="kwrd">void</span> DriveToSeattle(<span class="kwrd">string</span> name, TimeSpan timeToGasStation)
{
    <span class="rem">// Drive to gas station</span>
    Console.WriteLine(<span class="str">"[{0}] Leaving House"</span>, name);
    Thread.Sleep(timeToGasStation);
    Console.WriteLine(<span class="str">"[{0}] Arrived at Gas Station"</span>, name);

    <span class="rem">// Need to sync here</span>

    <span class="rem">// Perform some more work</span>
    Console.WriteLine(<span class="str">"[{0}] Leaving for Seattle"</span>, name);
}</pre>
<style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>

<p><a href="http://gwb.blob.core.windows.net/jolson/WindowsLiveWriter/AnIntroductiontoBarrier_D0FA/BeforeBarrier_2.jpg"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="BeforeBarrier" border="0" alt="BeforeBarrier" src="http://gwb.blob.core.windows.net/jolson/WindowsLiveWriter/AnIntroductiontoBarrier_D0FA/BeforeBarrier_thumb.jpg" width="686" height="350" /></a> </p>

<p>Well, that’s hardly a road trip. If I were in Mac’s or Charlie’s shoes when Dennis left for Seattle without me, I know I would be a little upset. We obviously don’t want that to happen. So we can use the new Barrier to make sure they all “wait up” for each other at the gas station.</p>

<h3>Using the new Barrier class</h3>

<p>So how do you use the new Barrier class? It’s actually quite simple.The cool thing is that there are really only three things you need to learn to use the Barrier for this simple type of scenario: a single constructor and two method calls (both of which take zero parameters). Yes, it’s that simple to use.</p>

<p>Let’s look at what our new code using Barrier looks like (the three bold lines are the new ones): </p>

<pre class="csharpcode"><strong><span class="kwrd">static</span> Barrier sync;</strong>

<span class="kwrd">static</span> <span class="kwrd">void</span> Main(<span class="kwrd">string</span>[] args)
{
    <strong>sync = <span class="kwrd">new</span> Barrier(participantCount:3);</strong>

    var charlie = <span class="kwrd">new</span> Thread(() =&gt; {
        DriveToSeattle(<span class="str">"Charlie"</span>, TimeSpan.FromSeconds(1))
    }); 
    charlie.Start();

    var mac = <span class="kwrd">new</span> Thread(() =&gt; {
        DriveToSeattle(<span class="str">"Mac"</span>, TimeSpan.FromSeconds(2))
    }); 
    mac.Start();

    var dennis = <span class="kwrd">new</span> Thread(() =&gt; {
        DriveToSeattle(<span class="str">"Dennis"</span>, TimeSpan.FromSeconds(3))
    }); 
    dennis.Start();

    charlie.Join();
    mac.Join();
    dennis.Join();

    Console.ReadKey();
}

<span class="kwrd">static</span> <span class="kwrd">void</span> DriveToSeattle(<span class="kwrd">string</span> name, TimeSpan timeToGasStation)
{
    <span class="rem">// Drive to gas station</span>
    Console.WriteLine(<span class="str">"[{0}] Leaving House"</span>, name);
    Thread.Sleep(timeToGasStation);
    Console.WriteLine(<span class="str">"[{0}] Arrived at Gas Station"</span>, name);

    <span class="rem">// Need to sync here</span>
    <strong>sync.SignalAndWait();</strong>

    <span class="rem">// Perform some more work</span>
    Console.WriteLine(<span class="str">"[{0}] Leaving for Seattle"</span>, name);
}</pre>
<style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style><style type="text/css"><![CDATA[


.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>

<p><a href="http://gwb.blob.core.windows.net/jolson/WindowsLiveWriter/AnIntroductiontoBarrier_D0FA/AfterBarrier_2.jpg"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="AfterBarrier" border="0" alt="AfterBarrier" src="http://gwb.blob.core.windows.net/jolson/WindowsLiveWriter/AnIntroductiontoBarrier_D0FA/AfterBarrier_thumb.jpg" width="684" height="348" /></a> </p>

<p>You can see now that nobody leaves for Seattle until everybody has arrived at the gas station. Essentially, with every call to SignalAndWait(), the number of signals received by the barrier is incremented. Once the number of signals received reaches the number of participants the Barrier was constructed with, all threads are then allowed to continue execution. And that’s all it takes to leverage the new Barrier class being introduced into the BCL with .NET Framework 4.0. </p>

<blockquote>
  <p><strong>But Jason</strong>... What is up with that line of code: “sync = new Barrier(participantCount:3);”? I mean, what the heck is “participantCount:3”? How is that valid syntax?</p>

  <p>Well, that’s easy. This is a new feature in C# 4.0 called Named Parameters where you can actually use a parameter’s name to specify what a value applies to. This becomes very handy in two places: 1) when combined with Optional Parameters, and 2) when used to clarify “magic numbers” (or “magic strings”, “magic booleans”, etc.) without having to introducing a temporary variable. </p>

  <p>In this case, I could have left out participantCount and written just “sync = new Barrier(3);”. But I personally don’t like a magic number like “3” just floating around like this and Named Parameters give me an easy way to provide more context about the value “3”.</p>
</blockquote>

<h3>In Closing</h3>

<p>So let’s look back at that <strike>boring</strike> technical description again:</p>

<blockquote>
  <p>A <strong>Barrier</strong> is a synchronization primitive that enforces the stopping of execution between a number of threads or processes at a given point and prevents further execution until all threads or processors have reached the given point.</p>
</blockquote>

<p>Think about it this way:</p>

<ul>
  <li>“stopping of execution between a number of threads...” = waiting for each other to arrive </li>

  <li>“… at a given point” = the gas station </li>

  <li>“prevents further execution until all threads… have reached the given point” = can’t leave for Seattle until everybody shows up </li>
</ul>

<p>See? Nice and simple!</p>

<p>Barrier is a great new synchronization primitive to use when there is a known amount of work to do that is being done by different workers that all have common synchronization points. However, if the amount of work needing to be done is not well known beforehand, Barrier is not the greatest primitive to use. Next we’ll look at another new synchronization primitive coming in .NET Framework 4.0 that is great to use when the amount of work is not known: the CountdownEvent. </p>

<p>I hope you all enjoyed this first stage in our Tour de BCL. Until the next stage, we’ll see you later.</p> <img src="http://geekswithblogs.net/jolson/aggbug/129304.aspx" width="1" height="1" />
