---
title: An Intro to Barrier, cont.d
---

<p>Originally posted on: <a href='http://geekswithblogs.net/jolson/archive/2009/02/24/an-intro-to-barrier-cont.d.aspx'>http://geekswithblogs.net/jolson/archive/2009/02/24/an-intro-to-barrier-cont.d.aspx</a></p><p>Well, I said I was going to be moving on to CountdownEvent, but I was wrong. there is one more aspect of using Barrier that I just had to share (thanks go to <a href="http://blogs.msdn.com/toub/">Stephen Toub</a> on the Parallel Computing Platform team for bringing this up). </p>  <p>In <a href="http://www.managed-world.com/archive/2009/02/09/an-intro-to-barrier.aspx">my first Barrier post</a>, I had mentioned:</p>  <blockquote>   <p>Barrier is a great new synchronization primitive to use when there is a known amount of work to do that is being done by different workers that all have common synchronization points.</p> </blockquote>  <p>To make a long story short, this isn’t strictly true. Barrier can be used just fine when there is an unknown amount of work. The distinction between Barrier and other synchronization primitives isn’t about “known amount versus unknown amount of work”, it’s more about “usable once versus usable many times.” To explain this in more detail, let’s look back at the example from the last post (a Road Trip to Seattle). </p>  <h3>Multiple Usages</h3>  <p>First, it is perfectly allowed to use a Barrier more than once. Using the Road Trip metaphor, instead of going straight to Seattle after leaving the Gas Station, let’s have everybody stop for lunch on there way. So now there are two “sync points” that we have. First, we’ll wait for everybody to meet up at the gas station, then we’ll also wait for everybody to meet up for lunch after they’ve left the gas station. </p>  <p>Revising our DriveToSeattle method from the last post, we will simply call SignalAndWait() a second time to provide a second sync point where everybody meets for lunch:</p>  <pre class="csharpcode"><span class="kwrd">static</span> <span class="kwrd">void</span> DriveToSeattle(<span class="kwrd">string</span> name, TimeSpan timeDelay)
{
    <span class="rem">// Perform some work</span>
    Console.WriteLine(<span class="str">"[{0}] Leaving House"</span>, name);
    Thread.Sleep(timeDelay);
    Console.WriteLine(<span class="str">"[{0}] Arrived at Gas Station"</span>, name);

    <span class="rem">// Need to wait for others</span>
    sync.SignalAndWait();

    <span class="rem">// Perform some work</span>
    Console.WriteLine(<span class="str">"[{0}] Leaving for Seattle"</span>, name);
    Thread.Sleep(timeDelay);
    Console.WriteLine(<span class="str">"[{0}] Meet for lunch"</span>, name);

    <span class="rem">// Need to wait for others</span>
    sync.SignalAndWait();

    Console.WriteLine(<span class="str">"[{0}] Leaving for Seattle"</span>, name);
}</pre>
<style type="text/css"><![CDATA[
.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>

<p>In real-word usage of the Barrier primitive, this doesn’t have to be limited to two uses of the Barrier. We can use the Barrier any number of times we need to in order to provide these common synchronization points for our parallel code. </p>

<h3>Unknown Number of Workers</h3>

<p>I mentioned that it wasn’t strictly true that Barrier is great for a just a known amount of work. That’s because Barrier provides the functionality you need to even use it when the number of workers performing our work is unknown. </p>

<p>Back to our Road Trip. Dennis’s sister Dee is planning to come along on the Road Trip as well. However, she forgets to set her alarm and wakes up late. And unfortunately, Charlie, Mac, and Dennis have already left for Seattle. She still wants to go though so she plans to meet up with them for lunch. </p>

<p>What we need is for a way for Dee to flag “Hey guys! I’m coming!” And it just so happens that the Barrier class provides an AddParticipant method that we can use to make sure the extra “worker” (Dee in this case) is included the next time everybody waits for each other to “complete their work.” </p>

<p>In this case, Dee would simply “add herself” to the Barrier when her thread is spun up. To do this, let’s create a new DriveStraightToLunch method that will be used instead of the existing DriveToSeattle method we created before. </p>

<pre class="csharpcode"><span class="kwrd">static</span> <span class="kwrd">void</span> DriveStraightToLunch(<span class="kwrd">string</span> name, TimeSpan timeDelay)
{
    <span class="rem">// "I'm coming along guys"</span>
    sync.AddParticipant();

    <span class="rem">// Meet for lunch</span>
    Console.WriteLine(<span class="str">"[{0}] Leaving for Seattle"</span>, name);
    Thread.Sleep(timeDelay);
    Console.WriteLine(<span class="str">"[{0}] Meeting for lunch"</span>, name);

    <span class="rem">// Need to wait for others</span>
    sync.SignalAndWait();

    Console.WriteLine(<span class="str">"[{0}] Leaving for Seattle"</span>, name);
}</pre>
<style type="text/css"><![CDATA[
.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>

<p>And then we just spin up this new piece of work (added to our code in Main before all threads are joined):</p>

<pre class="csharpcode">... creation and start of Dennis thread

Thread.Sleep(TimeSpan.FromSeconds(6));
var dee = <span class="kwrd">new</span> Thread(() =&gt; DriveStraightToLunch(<span class="str">"Dee"</span>, TimeSpan.FromSeconds(5)));
dee.Start();

dee.Join();
... join other threads</pre>
<style type="text/css"><![CDATA[
.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, "Courier New", courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }]]></style>

<p>It’s that simple.</p>

<h3>In Closing</h3>

<p>I hope in the last two posts you’ve seen how useful the new Barrier synchronization primitive can be when writing Parallel Code. API-wise there really isn’t much to the new Barrier class. Of course, as is usual with writing parallel code, it’s learning to use it correctly or use it in the right situations that’s the tricky part :). </p>

<p>I would say "tune in next time when we chat about CountdownEvent” but considering this recent change of plans, I’m not going to tempt fate :). Later!</p> <img src="http://geekswithblogs.net/jolson/aggbug/129647.aspx" width="1" height="1" />
